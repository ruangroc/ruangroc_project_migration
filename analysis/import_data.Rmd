---
title: "Let's Get the Data"
output: github_document 
---

I want to use more recent data, especially if I plan to predict migration flows in the near future, so I have
chosen to start with [US Population Migration Data](https://www.irs.gov/statistics/soi-tax-stats-migration-data), which has state inflow and outflow CSVs from 2009-2018. I decided to remove the .xls files from the unzipped folders because I won't be using them. I also had to download the 2017-18 state inflow csv because it wasn't included in the zip file for that year.

Should I have time to extend my models to capture global migration, I plan to use CSV data from [the OECD's International Migrantion Database](https://stats.oecd.org/Index.aspx?DataSetCode=MIG), which has data for the years 2000-2018. I renamed the CSV file 'OECD_migration_data.csv' in the data file.

(Might switch to doing US counties instead of international migration actually if I have enough time after getting states working)

```{r setup, message = FALSE, warning = FALSE, include = TRUE}
library(tidyverse)
library(here)
devtools::load_all()
```

## Create table for state FIPS and coordinates

Let's also create a tibble for matching state FIPS to state acronyms and state names.
```{r}
# 50 states + DC (excluding migration outside of the USA)
# the data files don't include US territories so I'm not including them either
# I also plan to calculate distances between states as distances between the 
# largest city in each state (more likely people are moving to/from bigger cities
# anyways, but this way I have only one long/lat pair per state to worry about)

states_fips <- tibble(
  fips = c(1, 2, 4, 5, 6, 8:13, 15:42, 44:51, 53:56),
  acronym = c("AL", "AK", "AZ", "AR", "CA", "CO", 
              "CT", "DE", "DC", "FL", "GA", "HI", 
              "ID", "IL", "IN", "IA", "KS", "KY", 
              "LA", "ME", "MD", "MA", "MI", "MN", 
              "MS", "MO", "MT", "NE", "NV", "NH", 
              "NJ", "NM", "NY", "NC", "ND", "OH", 
              "OK", "OR", "PA", "RI", "SC", "SD", 
              "TN", "TX", "UT", "VT", "VA", "WA", 
              "WV", "WI", "WY"),
  name = c("Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado",
           "Connecticut", "Delaware", "District of Columbia", "Florida", "Georgia", "Hawaii",
            "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky",
           "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota",
           "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire",
           "New Jersey", "New Mexico", "New York", "North Carolina", "North Dakota", "Ohio", 
           "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina", "South Dakota", 
           "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington", 
           "West Virginia", "Wisconsin", "Wyoming"),
  largest_city = c("Birmingham", "Anchorage", "Phoenix", "Little Rock", "Los Angeles", "Denver",
                   "Bridgeport", "Wilmington", "Washington", "Jacksonville", "Atlanta", "Honolulu",
                   "Boise", "Chicago", "Indianapolis", "Des Moines", "Wichita", "Louisville",
                   "New orleans", "Portland", "Baltimore", "Boston", "Detroit", "Minneapolis", 
                   "Jackson", "Kansas City", "Billings", "Omaha", "Las Vegas", "Manchester",
                   "Newark", "Albuquerque", "New York City", "Charlotte", "Fargo", "Columbus", 
                   "Oklahoma City", "Portland", "Philadelphia", "Providence", "Charleston", "Sioux Falls", 
                   "Nashville", "Houston", "Salt Lake City", "Burlington", "Virginia Beach", "Seattle", 
                   "Charleston", "Milwaukee", "Cheyenne"),
  latitude = c(33.52, 61.22, 33.45, 34.75, 34.05, 39.74, 
               41.18, 39.74, 38.89, 30.33, 33.75, 21.30, 
               43.62, 41.88, 39.77, 41.58, 37.69, 38.21,
               29.98, 43.68, 39.31, 42.33, 42.36, 44.98,
               32.31, 39.03, 45.79, 41.26, 36.17, 42.99,
               40.74, 35.10, 40.67, 35.21, 46.89, 39.96,
               35.52, 45.52, 39.96, 41.82, 32.79, 43.54,
               36.15, 29.73, 40.77, 44.47, 36.81, 47.60,
               38.35, 43.04, 41.13),
  longitude = c(-86.81, -149.90, -112.07, -92.29, -118.24, -104.99, 
                -73.19, -75.55, -77.03, -81.66, -84.39, -157.86,
                -116.20, -87.63, -86.15, -93.61, -97.33, -85.65,
                -90.03, -70.30, -76.62, -71.08, -83.08, -93.27,
                -90.20, -94.56, -108.52, -96.02, -115.19, -71.45,
                -74.18, -106.66, -73.98, -80.84, -96.81, -82.99,
                -97.50, -122.67, -75.15, -71.41, -79.94, -96.73,
                -86.77, -95.39, -111.89, -73.21, -76.12, -122.33,
                -81.63, -87.91, -104.82)
)

# write it out to a csv to save it
filename <- here("results", "data_cleaning_results", "states_fips.csv")
write.csv(states_fips, file = filename, row.names = FALSE)
```

## Load data for annual population estimates

Next, let's load in some data for population estimates for each state for each year.
```{r}
# Load the csv containing population estimates for each state for the years 2010 thru 2019
decade_2010s <- read.csv(here("data", "ACStables", "sub-est2019_all.csv"))
decade_2010s <- subset(decade_2010s, SUMLEV == 40)

# then load them in the population estimates tibble, with the exception
# of the 2009 year which is loaded in manually with data from an Excel sheet
pop_estimates <- tibble(
  fips = c(1, 2, 4, 5, 6, 8:13, 15:42, 44:51, 53:56),
  year_2009 = c(4757938, 698895, 6343154, 2896843, 36961229, 4972195, 
                3561807, 891730, 592228, 18652644, 9620846, 1346717, 
                1554439, 12796778, 6459325, 3032870, 2832704, 4317074, 
                4491648, 1329590, 5730388, 6517613, 9901591, 5281203, 
                2958774, 5961088, 983982, 1812683, 2684665, 1316102, 
                8755602, 2036802, 19307066, 9449566, 664968, 11528896, 
                3717572, 3808600, 12666858, 1053646, 4589872, 807067, 
                6306019, 24801761, 2723421, 624817, 7925937, 6667426, 
                1847775, 5669264, 559851),
  year_2010 = decade_2010s$POPESTIMATE2010,
  year_2011 = decade_2010s$POPESTIMATE2011,
  year_2012 = decade_2010s$POPESTIMATE2012,
  year_2013 = decade_2010s$POPESTIMATE2013,
  year_2014 = decade_2010s$POPESTIMATE2014,
  year_2015 = decade_2010s$POPESTIMATE2015,
  year_2016 = decade_2010s$POPESTIMATE2016,
  year_2017 = decade_2010s$POPESTIMATE2017,
)

# write it out to a csv to save it
filename <- here("results", "data_cleaning_results", "population_estimates.csv")
write.csv(pop_estimates, file = filename, row.names = FALSE)
```


Let's use the `join_with_pop_ests()` function I created to attach the population estimates to each origin or destination fips.

## Loading the Historical Migration Data

I'll start by loading the most recent US migration dataset (2017-18) for state inflows.
```{r}
load_US_1718 <- read.csv(here("data", "1718migrationdata", "stateinflow1718.csv"))
head(load_US_1718)
```

And let's compare it to the 2009-10 state inflow data.
```{r}
load_US_0910 <- read.csv(here("data", "state0910", "stateinflow0910.csv"))
head(load_US_0910)
```

We can see that the columns aren't the same for these two tables. We also probably want to put all of this information in the same tibble format for each year so that we can later construct the migration matrices we want.

```{r}
pop_estimates <- read.csv(here("results", "data_cleaning_results", "population_estimates.csv"))

#############################################################################################################
# 2009-2010 data

load_US_in_0910 <- read.csv(here("data", "state0910", "stateinflow0910.csv"))
load_US_out_0910 <- read.csv(here("data", "state0910", "stateoutflow0910.csv"))

# when loading, just ignore the county code column (all zeros)
US_0910 <- tibble(
  origin_fips = c(load_US_in_0910$State_Code_Origin, load_US_out_0910$State_Code_Origin),
  dest_fips = c(load_US_in_0910$State_Code_Dest, load_US_out_0910$State_Code_Dest),
  num_migrants = c(load_US_in_0910$Exmpt_Num, load_US_out_0910$Exmpt_Num)
)

clean_and_write(US_0910, "US_0910.csv", "year_2009")
#############################################################################################################

#############################################################################################################
# 2010-2011 data

load_US_in_1011 <- read.csv(here("data", "state1011", "stateinflow1011.csv"))
load_US_out_1011 <- read.csv(here("data", "state1011", "stateoutflow1011.csv"))

US_1011 <- tibble(
  origin_fips = c(load_US_in_1011$State_Code_Origin, load_US_out_1011$State_Code_Origin),
  dest_fips = c(load_US_in_1011$State_Code_Dest, load_US_out_1011$State_Code_Dest),
  num_migrants = c(load_US_in_1011$Exmpt_Num, load_US_out_1011$Exmpt_Num)
)

clean_and_write(US_1011, "US_1011.csv", "year_2010")
#############################################################################################################

#############################################################################################################
# 2011-2012 data
load_US_in_1112 <- read.csv(here("data", "1112migrationdata", "stateinflow1112.csv"))
load_US_out_1112 <- read.csv(here("data", "1112migrationdata", "stateoutflow1112.csv"))

US_1112 <- tibble(
  origin_fips = c(load_US_in_1112$y1_statefips, load_US_out_1112$y1_statefips),
  dest_fips = c(load_US_in_1112$y2_statefips, load_US_out_1112$y2_statefips),
  num_migrants = c(load_US_in_1112$n2, load_US_out_1112$n2)
)

clean_and_write(US_1112, "US_1112.csv", "year_2011")
#############################################################################################################

#############################################################################################################
# 2012-2013 data
load_US_in_1213 <- read.csv(here("data", "1213migrationdata", "stateinflow1213.csv"))
load_US_out_1213 <- read.csv(here("data", "1213migrationdata", "stateoutflow1213.csv"))

US_1213 <- tibble(
  origin_fips = c(load_US_in_1213$y1_statefips, load_US_out_1213$y1_statefips),
  dest_fips = c(load_US_in_1213$y2_statefips, load_US_out_1213$y2_statefips),
  num_migrants = c(load_US_in_1213$n2, load_US_out_1213$n2)
)

clean_and_write(US_1213, "US_1213.csv", "year_2012")
#############################################################################################################

#############################################################################################################
# 2013-2014 data
load_US_in_1314 <- read.csv(here("data", "1314migrationdata", "stateinflow1314.csv"))
load_US_out_1314 <- read.csv(here("data", "1314migrationdata", "stateoutflow1314.csv"))

US_1314 <- tibble(
  origin_fips = c(load_US_in_1314$y1_statefips, load_US_out_1314$y1_statefips),
  dest_fips = c(load_US_in_1314$y2_statefips, load_US_out_1314$y2_statefips),
  num_migrants = c(load_US_in_1314$n2, load_US_out_1314$n2)
)

clean_and_write(US_1314, "US_1314.csv", "year_2013")
#############################################################################################################

#############################################################################################################
# 2014-2015 data
load_US_in_1415 <- read.csv(here("data", "1415migrationdata", "stateinflow1415.csv"))
load_US_out_1415 <- read.csv(here("data", "1415migrationdata", "stateoutflow1415.csv"))

US_1415 <- tibble(
  origin_fips = c(load_US_in_1415$y1_statefips, load_US_out_1415$y1_statefips),
  dest_fips = c(load_US_in_1415$y2_statefips, load_US_out_1415$y2_statefips),
  num_migrants = c(load_US_in_1415$n2, load_US_out_1415$n2)
)

clean_and_write(US_1415, "US_1415.csv", "year_2014")
#############################################################################################################

#############################################################################################################
# 2015-2016 data
load_US_in_1516 <- read.csv(here("data", "1516migrationdata", "stateinflow1516.csv"))
load_US_out_1516 <- read.csv(here("data", "1516migrationdata", "stateoutflow1516.csv"))

US_1516 <- tibble(
  origin_fips = c(load_US_in_1516$y1_statefips, load_US_out_1516$y1_statefips),
  dest_fips = c(load_US_in_1516$y2_statefips, load_US_out_1516$y2_statefips),
  num_migrants = c(load_US_in_1516$n2, load_US_out_1516$n2)
)

clean_and_write(US_1516, "US_1516.csv", "year_2015")
#############################################################################################################

#############################################################################################################
# 2016-2017 data
load_US_in_1617 <- read.csv(here("data", "1617migrationdata", "stateinflow1617.csv"))
load_US_out_1617 <- read.csv(here("data", "1617migrationdata", "stateoutflow1617.csv"))

US_1617 <- tibble(
  origin_fips = c(load_US_in_1617$y1_statefips, load_US_out_1617$y1_statefips),
  dest_fips = c(load_US_in_1617$y2_statefips, load_US_out_1617$y2_statefips),
  num_migrants = c(load_US_in_1617$n2, load_US_out_1617$n2)
)

clean_and_write(US_1617, "US_1617.csv", "year_2016")
#############################################################################################################

#############################################################################################################
# 2017-2018 data
load_US_in_1718 <- read.csv(here("data", "1718migrationdata", "stateinflow1718.csv"))
load_US_out_1718 <- read.csv(here("data", "1718migrationdata", "stateoutflow1718.csv"))

US_1718 <- tibble(
  origin_fips = c(load_US_in_1718$y1_statefips, load_US_out_1718$y1_statefips),
  dest_fips = c(load_US_in_1718$y2_statefips, load_US_out_1718$y2_statefips),
  num_migrants = c(load_US_in_1718$n2, load_US_out_1718$n2)
)

clean_and_write(US_1718, "US_1718.csv", "year_2017")
#############################################################################################################
```



