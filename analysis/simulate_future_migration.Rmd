---
title: "Simulate Future Migration"
output: html_document
---

```{r setup, message = FALSE, warning = FALSE, include = TRUE}
library(tidyverse)
library(here)
devtools::load_all()
```


## Find the best alpha value for gravity model simulations 

**Optimize alpha**: Find the lowest alpha value that will minimize the least squares residual of the gravity model values.
```{r}
pop_estimates <- read.csv(here("results", "data_cleaning_results", "population_estimates.csv"))


# optimize returns: minimum = alpha, objective = residual value

# minimum alpha = 0.0154
filename <- here("results", "data_cleaning_results", "clean", "US_1516.csv")
optimize(f = run_gravity_model, interval = c(0, 1), year_data = pop_estimates$year_2015, hist_data_file = filename)

# minimum alpha = 0.0204
filename <- here("results", "data_cleaning_results", "clean", "US_1617.csv")
optimize(f = run_gravity_model, interval = c(0, 1), year_data = pop_estimates$year_2016, hist_data_file = filename)

# minimum alpha = 0.0157
filename <- here("results", "data_cleaning_results", "clean", "US_1718.csv")
optimize(f = run_gravity_model, interval = c(0, 1), year_data = pop_estimates$year_2017, hist_data_file = filename)

gravity_alpha <- mean(c(0.0154, 0.0204, 0.0157))
# we'll use alpha = 0.0172 for predicting future migration using gravity model
```

## Find best alpha value for radiation model simulations

**Optimize alpha**: Find the lowest alpha value that will minimize the least squares residual of the radiation model values.
```{r}
pop_estimates <- read.csv(here("results", "data_cleaning_results", "population_estimates.csv"))

# min alpha = 0.0199
S_ij_file <- here("results", "radiation_model_results", "intervening_opportunities_year_2015.csv")
hist_file <- here("results", "data_cleaning_results", "clean", "US_1516.csv")
optimize(f = run_radiation_model, interval = c(0, 1), year_data = pop_estimates$year_2015, S_ij_file = S_ij_file, hist_data_file = filename)

# min alpha = 0.0198
S_ij_file <- here("results", "radiation_model_results", "intervening_opportunities_year_2016.csv")
hist_file <- here("results", "data_cleaning_results", "clean", "US_1617.csv")
optimize(f = run_radiation_model, interval = c(0, 1), year_data = pop_estimates$year_2016, S_ij_file = S_ij_file, hist_data_file = filename)

# min alpha = 0.0194
S_ij_file <- here("results", "radiation_model_results", "intervening_opportunities_year_2017.csv")
hist_file <- here("results", "data_cleaning_results", "clean", "US_1718.csv")
optimize(f = run_radiation_model, interval = c(0, 1), year_data = pop_estimates$year_2017, S_ij_file = S_ij_file, hist_data_file = filename)

radiation_alpha <- mean(c(0.0199, 0.0198, 0.0194))
# we'll use alpha = 0.0197 for predicting future migration using radiation model
```


## Predict migration flows for next 3 years

Now that we've found the most optimal alpha values to use for predicting future migration, let's put them to use.

The most recent data we have is for the 2017-18 tax year. We'll use the population estimates from that year as a starting point and calculate estimated population from that point onwards.

**Simulate migrations using gravity model**
```{r}
pop_estimates <- read.csv(here("results", "data_cleaning_results", "population_estimates.csv"))
pop_data_2017 <- pop_estimates$year_2017

# get a migration matrix for the year 2018, use it in 2019's prediction, and so on
pop_data_2018 <- get_gravity_prediction(pop_data_2017, 2018, gravity_alpha)
pop_data_2019 <- get_gravity_prediction(pop_data_2018, 2019, gravity_alpha)
pop_data_2020 <- get_gravity_prediction(pop_data_2019, 2020, gravity_alpha)
pop_data_2021 <- get_gravity_prediction(pop_data_2020, 2021, gravity_alpha)
pop_data_2022 <- get_gravity_prediction(pop_data_2021, 2022, gravity_alpha)

# then visualize the results (population changes predicted by gravity model)
```

**Simulate migrations using radiation model**

```{r}
pop_estimates <- read.csv(here("results", "data_cleaning_results", "population_estimates.csv"))
pop_data_2017 <- pop_estimates$year_2017

s_ij_file <- here("results", "radiation_model_results", "intervening_opportunities_year_2017.csv")
new_s_ij_file <- here("results", "simulation_results", "intervening_opportunities_2018.csv")
pop_data_2018 <- get_radiation_prediction(pop_data_2017, s_ij_file, new_s_ij_file, 2018, radiation_alpha)

s_ij_file <- here("results", "simulation_results", "intervening_opportunities_2018.csv")
new_s_ij_file <- here("results", "simulation_results", "intervening_opportunities_2019.csv")
pop_data_2019 <- get_radiation_prediction(pop_data_2018, s_ij_file, new_s_ij_file, 2019, radiation_alpha)

s_ij_file <- here("results", "simulation_results", "intervening_opportunities_2019.csv")
new_s_ij_file <- here("results", "simulation_results", "intervening_opportunities_2020.csv")
pop_data_2020 <- get_radiation_prediction(pop_data_2019, s_ij_file, new_s_ij_file, 2020, radiation_alpha)

s_ij_file <- here("results", "simulation_results", "intervening_opportunities_2020.csv")
new_s_ij_file <- here("results", "simulation_results", "intervening_opportunities_2021.csv")
pop_data_2021 <- get_radiation_prediction(pop_data_2020, s_ij_file, new_s_ij_file, 2021, radiation_alpha)

s_ij_file <- here("results", "simulation_results", "intervening_opportunities_2021.csv")
new_s_ij_file <- here("results", "simulation_results", "intervening_opportunities_2022.csv")
pop_data_2022 <- get_radiation_prediction(pop_data_2021, s_ij_file, new_s_ij_file, 2022, radiation_alpha)
```



