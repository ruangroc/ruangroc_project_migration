---
title: "Gravity Model"
output: html_document
---

```{r setup, message = FALSE, warning = FALSE, include = TRUE}
library(tidyverse)
library(here)
library(Imap)
library(Rmpfr)
#devtools::load_all()
```

## Background research
As seen in the image below and as explained in Caleb Robinson and Bistra Dilkina's paper, ["A Machine Learning Approach to Modeling Human Migration"](https://doi.org/10.1145/3209811.3209868), the traditional migration models can be written as the product of two parts: $T_{ij} = G_i * P_{ij}$. 

  * $T_{ij}$ is the number of people moving from every zone i to every other zone j
  * $G_i = \alpha * m_i$ is the production function that estimates number of people leaving zone i
    * $m_i$ is the population of zone i and alpha is a parameter tuned using historical data
  * $P_{ij}$ is the probability of a move occurring from i to j
    * Robinson and Dilkina note that the probability of moving from i to all other destinations j should sum to 1

```{r pressure, echo=FALSE, out.width = '75%'}
knitr::include_graphics(here("documentation", "project_notes", "Robinson_and_Dilkina_Table_1.PNG"))
```

I'll be using the alpha value of 0.3 that Robinson and Dilkina used in their paper to substitute for the beta variables in the gravity model with power law equation, which is what they appeared to do in their [MigrationModels.py](https://github.com/calebrob6/migration-lib/blob/master/MigrationModels.py) file.


## What do I need to do? (make plan of action into a more coherent agenda of following content)

Matrices to create:
* distances between all i and j
* m_i for all zones i (each row is a zone i)
* G_i = alpha * m_i
* m_j for all zones j (each column is a zone j)
* d^-alpha matrix
* numerator = m_i * m_j * d^alpha
* row_sums (single value for each row, the value being the sum of all values in the numerator row)
* P_ij = numerator / row_sums

## Create distances matrix for all (i, j)
```{r}
states_fips <- read.csv(here("results", "data_cleaning_results", "states_fips.csv"))

locations <- tibble(
  origin = rep(states_fips$fips, each = 51),
  origin_lon = rep(states_fips$longitude, each = 51),
  origin_lat = rep(states_fips$latitude, each = 51),
  dest = rep(states_fips$fips, times = 51),
  dest_lon = rep(states_fips$longitude, times = 51),
  dest_lat = rep(states_fips$latitude, times = 51)
)


locations <- locations %>%
  mutate(
    distance = pmap_dbl(list(origin_lon, origin_lat, dest_lon, dest_lat, units = "miles"), gdist)
  )

filename <- here("results", "distances_between_states.csv")
write.csv(locations, file = filename, row.names = FALSE)
```


```{r}
locations <- read.csv(here("results", "distances_between_states.csv"))

# it was filling with negative values for some reason
distances <-- matrix(-locations$distance, nrow = 51, ncol = 51, byrow = TRUE)
colnames(distances) <- states_fips$fips
rownames(distances) <- states_fips$fips
```


## Create m_i and m_j matrices
Filling the values in by column means there'll be the same value for each row
```{r}
m_i <- matrix(rep(pop_estimates$year_2009, times = 51), nrow = 51, ncol = 51)
colnames(m_i) <- states_fips$fips

m_j <- matrix(rep(pop_estimates$year_2009, times = 51), nrow = 51, ncol = 51, byrow = TRUE)
rownames(m_j) <- states_fips$fips
```


## Test area
```{r}
G_i <- 0.3 * m_i

d_alpha <- distances^-0.3
# replace Inf values with 0
d_alpha[!is.finite(d_alpha)] <- 0

part1 <- d_alpha * m_j
numerator <- part1 * m_i
denom <- matrix(rep(rowSums(part1), times = 51), nrow = 51, ncol = 51)
P_ij <- numerator / denom
# Now the calculation should be right, but maybe normalization happens after this step (gotta take row sums of P_ij)

normalize <- matrix(rep(rowSums(P_ij), times = 51), nrow = 51, ncol = 51)
P_ij <- P_ij / normalize
T_ij <- G_i * P_ij
T_ij <- round(T_ij, 4)
```


## Create a function to compute gravity model prediction for every single dataset
```{r}
gravity_model <- function(data, names, alpha) {
  
  # load population estimates for each state for the given year
  m_i <- matrix(rep(data, times = 51), nrow = 51, ncol = 51)
  colnames(m_i) <- names
  m_j <- matrix(rep(data, times = 51), nrow = 51, ncol = 51, byrow = TRUE)
  rownames(m_j) <- names
  
  # load distance matrix
  locations <- read.csv(here("results", "distances_between_states.csv"))
  distances <-- matrix(-locations$distance, nrow = 51, ncol = 51, byrow = TRUE)
  colnames(distances) <- names
  rownames(distances) <- names
  
  d_alpha <- distances^(-alpha)
  d_alpha[!is.finite(d_alpha)] <- 0
  
  G_i <- alpha * m_i
  
  part1 <- d_alpha * m_j
  numerator <- m_i * part1
  numerator[!is.finite(numerator)] <- 0
  
  denom <- matrix(rep(rowSums(part1), times = 51), nrow = 51, ncol = 51)
  
  P_ij <- numerator / denom
  
  normalize <- matrix(rep(rowSums(P_ij), times = 51), nrow = 51, ncol = 51)
  P_ij <- P_ij / normalize

  T_ij <- G_i * P_ij
  T_ij[T_ij < 0] <- 0
  
  return(T_ij)
}
```

Let's test this
```{r}
pop_estimates <- read.csv(here("results", "data_cleaning_results", "population_estimates.csv"))

alpha <- 0.3

T_ij <- gravity_model(pop_estimates$year_2009, pop_estimates$fips, 0.3)
result <- round(T_ij, 4)
filename <- paste("alpha_",as.character(alpha), "_US0910.csv", sep = '')
write.csv(result, here("results", "gravity_model_results", filename))
```

And then run it for all the other years too
```{r}
T_ij <- gravity_model(pop_estimates$year_2010, pop_estimates$fips, 0.3)
result <- round(T_ij, 4)
filename <- paste("alpha_",as.character(alpha), "_US1011.csv", sep = '')
write.csv(result, here("results", "gravity_model_results", filename), row.names = FALSE)

T_ij <- gravity_model(pop_estimates$year_2011, pop_estimates$fips, 0.3)
result <- round(T_ij, 4)
filename <- paste("alpha_",as.character(alpha), "_US1112.csv", sep = '')
write.csv(result, here("results", "gravity_model_results", filename), row.names = FALSE)

T_ij <- gravity_model(pop_estimates$year_2012, pop_estimates$fips, 0.3)
result <- round(T_ij, 4)
filename <- paste("alpha_",as.character(alpha), "_US1213.csv", sep = '')
write.csv(result, here("results", "gravity_model_results", filename), row.names = FALSE)

T_ij <- gravity_model(pop_estimates$year_2013, pop_estimates$fips, 0.3)
result <- round(T_ij, 4)
filename <- paste("alpha_",as.character(alpha), "_US1314.csv", sep = '')
write.csv(result, here("results", "gravity_model_results", filename), row.names = FALSE)

T_ij <- gravity_model(pop_estimates$year_2014, pop_estimates$fips, 0.3)
result <- round(T_ij, 4)
filename <- paste("alpha_",as.character(alpha), "_US1415.csv", sep = '')
write.csv(result, here("results", "gravity_model_results", filename), row.names = FALSE)

T_ij <- gravity_model(pop_estimates$year_2015, pop_estimates$fips, 0.3)
result <- round(T_ij, 4)
filename <- paste("alpha_",as.character(alpha), "_US1516.csv", sep = '')
write.csv(result, here("results", "gravity_model_results", filename), row.names = FALSE)

T_ij <- gravity_model(pop_estimates$year_2016, pop_estimates$fips, 0.3)
result <- round(T_ij, 4)
filename <- paste("alpha_",as.character(alpha), "_US1617.csv", sep = '')
write.csv(result, here("results", "gravity_model_results", filename), row.names = FALSE)

T_ij <- gravity_model(pop_estimates$year_2017, pop_estimates$fips, 0.3)
result <- round(T_ij, 4)
filename <- paste("alpha_",as.character(alpha), "_US1718.csv", sep = '')
write.csv(result, here("results", "gravity_model_results", filename), row.names = FALSE)
```

